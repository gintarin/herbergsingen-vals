<!DOCTYPE html>
<html>
<head>
    <title>Herbergsingen Vals</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; } /* Vollbild */
        
        /* Design f√ºr die Hausnummern */ 
        .haus-label {
            background: rgba(255,255,255,0.8);
            border: 1px solid #666;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            font-size: 10px;
            padding: 1px;
            min-width: 15px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    // --- KONFIGURATION ---
    const SUPABASE_URL = 'https://cjzrrvdcyqbgavqkfmjv.supabase.co'; // .co ist wichtig!
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqenJydmRjeXFiZ2F2cWtmbWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MDcwMTcsImV4cCI6MjA4MzQ4MzAxN30.UquzNqUVLr0dCqiN7XxoB7hO7_Vsz2zbgcIgWskdVc4';
    
    const MY_GROUP = "Gruppe 1"; 

    // Supabase verbinden
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- KARTE INITIALISIEREN ---
    // Startpunkt Vals
    var map = L.map('map').setView([46.843, 11.625], 15);

    // 1. WICHTIG: Wir nutzen jetzt die STANDARD OSM Karte (die funktioniert immer!)
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- NEU: GPS "WO BIN ICH" BUTTON ---
    // Wir bauen einen Knopf direkt auf die Karte
    var gpsControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            container.style.backgroundColor = 'white';
            container.style.width = '30px';
            container.style.height = '30px';
            container.style.cursor = 'pointer';
            container.innerHTML = 'üìç'; // Das Icon
            container.style.fontSize = '20px';
            container.style.textAlign = 'center';
            container.style.lineHeight = '30px';
            
            container.onclick = function(){
                map.locate({setView: true, maxZoom: 18});
            }
            return container;
        }
    });
    map.addControl(new gpsControl());

    // Wenn GPS Position gefunden wurde: Blauen Punkt malen
    map.on('locationfound', function(e) {
        var radius = e.accuracy / 2;
        L.circle(e.latlng, radius).addTo(map);
        L.circleMarker(e.latlng, {color: 'blue', fillColor: '#3388ff', fillOpacity: 1, radius: 5}).addTo(map)
        .bindPopup("Ihr seid hier!").openPopup();
    });

    // Fehler abfangen (falls GPS aus ist)
    map.on('locationerror', function(e) {
        alert("GPS Fehler: " + e.message);
    });

    // --- H√ÑUSER LOGIK ---
    var houseLayers = {};

    function getColor(status) {
        switch(status) {
            case 'green': return '#2ecc71'; 
            case 'yellow': return '#f1c40f'; 
            case 'red': return '#e74c3c'; 
            case 'blue': return '#3498db'; 
            default: return 'gray'; 
        }
    }

    async function setStatus(houseId, newStatus) {
        // Optimistisch: Sofort Farbe √§ndern, damit es sich schnell anf√ºhlt
        updateMapColor(houseId, newStatus);

        const { error } = await db
            .from('visits')
            .upsert({ 
                house_id: String(houseId), 
                status: newStatus,
                group_name: MY_GROUP,
                created_at: new Date() 
            }, { onConflict: 'house_id' });

        if (error) {
            alert("Fehler beim Speichern: " + error.message);
            // Wenn Fehler: Farbe zur√ºcksetzen (Reload der Seite w√ºrde es auch fixen)
        }
        map.closePopup();
    }

    // Daten laden
    fetch('vals.json')
        .then(res => res.json())
        .then(data => {
            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    var id = feature.id;
                    var nr = feature.properties["addr:housenumber"] || "?";
                    
                    var marker = L.circleMarker(latlng, {
                        radius: 10,
                        fillColor: 'gray',
                        color: "#333",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    marker.bindTooltip(nr, { permanent: true, direction: "center", className: "haus-label" });
                    
                    var popupContent = `
                        <b>Hausnr: ${nr}</b><br><br>
                        <button onclick="setStatus('${id}', 'green')" style="background:#2ecc71;padding:10px;border:none;cursor:pointer;">‚úÖ Fertig</button>
                        <button onclick="setStatus('${id}', 'red')" style="background:#e74c3c;padding:10px;border:none;cursor:pointer;">‚ùå Nein</button><br><br>
                        <button onclick="setStatus('${id}', 'blue')" style="background:#3498db;padding:10px;border:none;cursor:pointer;">üîµ Sp√§ter</button>
                    `;
                    marker.bindPopup(popupContent);
                    houseLayers[id] = marker;
                    return marker;
                }
            }).addTo(map);

            loadInitialStatus();
        });

    async function loadInitialStatus() {
        let { data: visits, error } = await db.from('visits').select('*');
        if (visits) {
            visits.forEach(visit => {
                updateMapColor(visit.house_id, visit.status);
            });
        }
    }

    // Live Updates
    db.channel('custom-all-channel')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'visits' }, (payload) => {
        if (payload.new) {
            updateMapColor(payload.new.house_id, payload.new.status);
        }
    }).subscribe();

    function updateMapColor(houseId, status) {
        var layer = houseLayers[houseId];
        if (layer) {
            layer.setStyle({ fillColor: getColor(status) });
        }
    }
</script>
</body>
</html>
